# Backend — CLAUDE.md

Go 1.24 API — chi router, PostgreSQL 16 (pgx + sqlc), JWT auth (HS256), golang-migrate.

## Layer Flow

```
handler -> service -> store (sqlc-generated)
```

- **handler/**: HTTP layer. Parses requests, validates with `go-playground/validator` struct tags, calls service, responds via `respond.JSON/Error/NoContent`. Extracts user ID with `middleware.UserID(r.Context())`.
- **service/**: Business logic. Receives Go types, converts to pgtype for store calls using helpers in `service/convert.go`, converts store models back to DTOs.
- **store/**: **Auto-generated by sqlc — do not edit.** Edit SQL in `queries/*.sql` then run `make sqlc` from repo root.
- **dto/dto.go**: All request/response types in one file.
- **cmd/api/main.go**: Entry point. Manual constructor injection (config -> pool -> queries -> services -> handlers -> router). Migrations run automatically at startup.

## Key Patterns

- **pgtype conversions**: PostgreSQL decimals use `pgtype.Numeric`, not float64. Use helpers in `service/convert.go` (`numericFromString`, `numericToString`, `numericAdd`, `numericSub`, `dateFromString`, `dateToString`, `uuidToNullable`, `nullableToUUID`).
- **Nullable SQL filters**: `sqlc.narg('param')::TYPE IS NULL OR column = sqlc.narg('param')` pattern for optional WHERE clauses.
- **Monetary amounts**: Always strings (decimal), never float. Paired with currency code.
- **Auth scoping**: Every DB query filters by `user_id`. Services receive userID as parameter.
- **Transfers**: Two linked transactions sharing a `transfer_id` UUID (expense on source, income on destination).
- **Reports**: Exclude transfer transactions (`WHERE transfer_id IS NULL`) to avoid double-counting.
- **Sentinel errors**: Service layer defines `ErrNotFound`, `ErrUserExists`, `ErrInvalidCredentials`, etc. Handlers match these to HTTP status codes.

## Adding a New Endpoint

1. Add SQL in `queries/` -> `make sqlc` from repo root
2. Add request/response types in `dto/dto.go`
3. Add service method (dto <-> pgtype conversions)
4. Add handler method (parse, validate, call service, respond)
5. Register route in `server/routes.go`
6. Wire service + handler in `cmd/api/main.go`

## sqlc

Config: `sqlc.yaml` — generates to `internal/store/` package, uses `pgx/v5`, maps `uuid` to `google/uuid.UUID`. Annotations: `-- name: FuncName :one/:many/:exec/:copyfrom`.

## Documentation

- API changes -> [docs/API.md](docs/API.md)
- Architecture changes -> [docs/Architecture.md](docs/Architecture.md)
- Feature/command changes -> [README.md](README.md)
